<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gate Control</title>

    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/state-styles.css">
    <script src="/config.js"></script>

    <style>
    button {
      border: 1px solid hsl(221, 33%, 30%);
      padding: 10px 15px;
      color: white;
      text-decoration: none;
      border-radius: 50px;
      transition-duration: .1s;
      background:hsl(221, 33%, 15%);
    }

    button:hover {
      background:hsl(221, 33%, 30%);
    }

    button:active {
      background:hsl(221, 33%, 10%);
    }

    button:disabled {
      opacity: 0.35;
      pointer-events: none;
    }

    div.controlbar {
      display: flex;
      gap: 10px;
    }

    .state-container {
      display: flex;
      align-items: center;
      gap: 15px;
      padding-top: 10px;
    }
    </style>

    <script>
    const message_responses = {
      raised: {
        style: 'raised',
        text: 'Raised'
      },
      raising: {
        style: 'indeterminate',
        text: 'Raising...'
      },
      lowered: {
        style: 'lowered',
        text: 'Lowered'
      },
      lowering: {
        style: 'indeterminate',
        text: 'Lowering...'
      }
    };

    let config = null;

    function createControls(gateID) {
      let result = {
        id: gateID,
        stateElement: null
      };

      let header = document.createElement('p');
      header.innerText = `Gate #${gateID}`;

      let controlBar = document.createElement('div');
      controlBar.className = 'controlbar';
      controlBar.id = 'controlbar-' + gateID;
      
      let raiseButton = document.createElement('button');
      raiseButton.innerText = 'Raise';
      raiseButton.id = 'raise';

      let lowerButton = document.createElement('button');
      lowerButton.innerText = 'Lower';
      lowerButton.id = 'lower';

      controlBar.appendChild(raiseButton);
      controlBar.appendChild(lowerButton);

      let stateElement = document.createElement('div');
      stateElement.className = 'state-block';
      stateElement.id = 'state-block-' + gateID;
      stateElement.innerHTML = '<span class="state"></span><p>Connecting...</p>';

      result.stateElement = stateElement;

      let container = document.querySelector("body > div");
      container.appendChild(header);
      container.appendChild(controlBar);
      container.appendChild(stateElement);

      return result;
    }
    </script>
  </head>
  <body>
    <div>
      <h1>Control Page</h1>

      <!-- <div class="controlbar">
        <button disabled id="send-up">Raise</button>
        <button disabled id="send-down">Lower</button>
      </div>

      <div class="state-container">
        <p>Gate state: </p>
        <div class="state-block">
          <span class="state"></span>
          <p>Connecting...</p>
        </div>
      </div> -->
    </div>

    <script>
    let ws = new WebSocket("ws://" + location.host + location.pathname);
    const stateSpan = document.querySelector("span.state");
    const stateText = document.querySelector("div.state-block > p");

    getConfig().then(c => {
      config = c;

      for (const gate of config.gates) {
        createControls(gate.id);
      }
    });

    function setButtonState(state) {
      while (!config);
      for (const gate of config.gates) {
        document.querySelectorAll(`#raise, #lower`).forEach(el => el.disabled = !state);
      }
    }

    ws.addEventListener('message', e => {
      let msg = JSON.parse(e.data);
      if (msg.type == "text") alert(`Text from Server: ${msg.payload}`);
      if (msg.type == "query_state_result") {
        const gateStates = msg.payload;
        for (const state of gateStates) {
          let stateBlock = document.querySelector(`#state-block-${state.id}`);

          if (!stateBlock) {
            continue;
          }

          const { text, style } = message_responses[state.state];

          stateBlock.querySelector("span.state").className = "state " + style;
          stateBlock.querySelector("p").innerText = text;
        }
      }
    });

    ws.addEventListener('close', () => {
      while (!config);
      for (const gate of config.gates) {
        document.querySelector(`#state-block-${gate.id} > span.state`).className = "state";
        document.querySelector(`#state-block-${gate.id} > p`).innerText = "Disconnected";
      }

      setButtonState(false);
    });

    ws.addEventListener('error', () => {
      while (!config);
      for (const gate of config.gates) {
        document.querySelector(`#state-block-${gate.id} > span.state`).className = "state";
        document.querySelector(`#state-block-${gate.id} > p`).innerText = "Communication Error";
      }

      setButtonState(false);
    });

    function setListener(selector, type, listener) {
      document.querySelector(selector).addEventListener(type, listener);
    }

    function bindMessage(selector, msgObj) {
      setListener(selector, "click", () => ws.send(JSON.stringify(msgObj)));
    }

    ws.addEventListener('open', () => {
      while (!config);
      for (const gate of config.gates) {
        bindMessage(`#controlbar-${gate.id} > #raise`, { type: "change_state", payload: { id: gate.id, state: true }});
        bindMessage(`#controlbar-${gate.id} > #lower`, { type: "change_state", payload: { id: gate.id, state: false }});
      }
    });
    </script>
  </body>
</html>


